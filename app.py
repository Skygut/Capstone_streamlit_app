import streamlit as st
import pandas as pd
from PIL import Image

# =====================================================
# BASIC CONFIG
# =====================================================

st.set_page_config(page_title="Rossmann Sales Forecasting ‚Äî Dashboard", layout="wide")

st.title("üìä Rossmann Store Sales Forecasting ‚Äî –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π Dashboard")
st.write(
    """
    –¶–µ —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –ø—Ä–æ–¥–∞–∂—ñ–≤ —É –º–µ—Ä–µ–∂—ñ Rossmann.  
    –î–∞–Ω—ñ, –º–æ–¥–µ–ª—ñ —Ç–∞ –≥—Ä–∞—Ñ—ñ–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –∑–∞–≤—á–∞—Å–Ω–æ ‚Äî –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –Ω–µ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è.
    """
)

# Sidebar Navigation
st.sidebar.title("–ú–µ–Ω—é")
page = st.sidebar.radio(
    "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ä–æ–∑–¥—ñ–ª—É:",
    [
        "–û–≥–ª—è–¥ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è",
        "EDA ‚Äî –î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö",
        "Feature Engineering",
        "–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –º–æ–¥–µ–ª–µ–π",
        "–ü—Ä–æ–≥–Ω–æ–∑–∏ –º–æ–¥–µ–ª–µ–π",
        "–ê–Ω–∞–ª—ñ–∑ –∑–∞–ª–∏—à–∫—ñ–≤",
        "SHAP ‚Äî –ü–æ—è—Å–Ω–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ",
        "–í–∏—Å–Ω–æ–≤–∫–∏",
    ],
)


# =====================================================
# 1. OVERVIEW
# =====================================================
if page == "–û–≥–ª—è–¥ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è":

    st.header("üìå –û–ø–∏—Å —Ä–æ–±–æ—Ç–∏")
    st.write(
        """
        –ú–µ—Ç–∞ —Ä–æ–±–æ—Ç–∏ ‚Äî –ø–æ–±—É–¥—É–≤–∞—Ç–∏ —Ç–æ—á–Ω—É –º–æ–¥–µ–ª—å –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è —â–æ–¥–µ–Ω–Ω–∏—Ö –ø—Ä–æ–¥–∞–∂—ñ–≤ –º–∞–≥–∞–∑–∏–Ω—ñ–≤ Rossmann.  
        –£ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ñ –º–æ–¥–µ–ª—ñ: **XGBoost**, **CatBoost**, **RandomForest**,  
        –∞ —Ç–∞–∫–æ–∂ –∞–Ω—Å–∞–º–±–ª–µ–≤—ñ –ø—ñ–¥—Ö–æ–¥–∏: **Weighted Ensemble** —Ç–∞ **Stacked Ensemble**.
        """
    )

    st.subheader("üîß –û—Å–Ω–æ–≤–Ω—ñ –∫—Ä–æ–∫–∏")
    st.write(
        """
        1. –û—á–∏—â–µ–Ω–Ω—è —Ç–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö  
        2. –Ü–Ω–∂–µ–Ω–µ—Ä—ñ—è –æ–∑–Ω–∞–∫  
        3. –ü–æ–±—É–¥–æ–≤–∞ —Ç–∞ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –º–æ–¥–µ–ª–µ–π  
        4. –û—Ü—ñ–Ω–∫–∞ —è–∫–æ—Å—Ç—ñ –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤  
        5. –ü–æ—è—Å–Ω–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ —á–µ—Ä–µ–∑ SHAP  
        """
    )

    st.subheader("‚≠ê –ù–∞–π–∫—Ä–∞—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç")
    st.info("–°—Ç–µ–∫—ñ–Ω–≥ –º–æ–¥–µ–ª–µ–π –¥–∞–≤ –Ω–∞–π–∫—Ä–∞—â—É —Ç–æ—á–Ω—ñ—Å—Ç—å: **RMSE ‚âà 934**, **R¬≤ ‚âà 0.91**")


# =====================================================
# 2. EDA ‚Äî Exploratory Data Analysis
# =====================================================
elif page == "EDA ‚Äî –î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö":

    st.header("üìä EDA ‚Äî –ê–Ω–∞–ª—ñ–∑ –¥–∞–Ω–∏—Ö")

    st.subheader("1. –†–æ–∑–ø–æ–¥—ñ–ª –ø—Ä–æ–¥–∞–∂—ñ–≤")
    st.image("plots/eda_sales_distribution.png", use_container_width=True)

    st.subheader("2. –í–ø–ª–∏–≤ –ø—Ä–æ–º–æ-–∞–∫—Ü—ñ–π")
    st.image("plots/eda_promo_effect.png", use_container_width=True)

    st.subheader("3. –ö–æ—Ä–µ–ª—è—Ü—ñ–π–Ω–∏–π –∞–Ω–∞–ª—ñ–∑")
    col1, col2 = st.columns(2)

    with col1:
        st.caption("–î–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏—Ö –æ–∑–Ω–∞–∫")
        st.image("plots/correlation_before.png", use_container_width=True)

    with col2:
        st.caption("–ü—ñ—Å–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏—Ö –æ–∑–Ω–∞–∫")
        st.image("plots/correlation_after.png", use_container_width=True)


# =====================================================
# 3. FEATURE ENGINEERING
# =====================================================
elif page == "Feature Engineering":

    st.header("üõ† Feature Engineering")

    st.write(
        """
        –ü—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–∑–Ω–∞–∫ –≤–∏–∫–æ–Ω–∞–Ω–æ —Ç–∞–∫—ñ –∫—Ä–æ–∫–∏:

        - –≤–∏–¥–∞–ª–µ–Ω–æ –Ω–µ–∫–æ—Ä–∏—Å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ  
        - –¥–æ–¥–∞–Ω–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ñ –æ–∑–Ω–∞–∫–∏: `Year`, `Month`, `Week`, `Day`, `DayOfWeek`, `IsWeekend`  
        - –¥–æ–¥–∞–Ω–æ –æ–∑–Ω–∞–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü—ñ—ó  
        - —Å—Ç–≤–æ—Ä–µ–Ω–æ –æ–∑–Ω–∞–∫–∏ –ø—Ä–æ–º–æ-–∞–∫—Ü—ñ–π  
        - –≤–∏–¥–∞–ª–µ–Ω–æ –æ–∑–Ω–∞–∫–∏ –∑ –≤–∏—Å–æ–∫–æ—é –∫–æ—Ä–µ–ª—è—Ü—ñ—î—é (> 0.9)  
        """
    )

    st.subheader("üìÑ –¢–∞–±–ª–∏—Ü—è —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –æ–∑–Ω–∞–∫ (–ø—Ä–∏–∫–ª–∞–¥)")

    df_features = pd.DataFrame(
        {
            "–û–∑–Ω–∞–∫–∞": ["Year", "Month", "Day", "Promo2Active", "CompetitionOpen"],
            "–û–ø–∏—Å": [
                "–†—ñ–∫ –∑ –¥–∞—Ç–∏",
                "–ú—ñ—Å—è—Ü—å –∑ –¥–∞—Ç–∏",
                "–î–µ–Ω—å –º—ñ—Å—è—Ü—è",
                "–ß–∏ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–∞ –ø—Ä–æ–º–æ",
                "–ß–∏ –ø—Ä–∞—Ü—é—î –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç",
            ],
        }
    )
    st.dataframe(df_features, use_container_width=True)

    # ------ FEATURE IMPORTANCE (ElasticNet) -------
    st.subheader("2. –í–∞–∂–ª–∏–≤—ñ—Å—Ç—å –æ–∑–Ω–∞–∫ (–ª—ñ–Ω—ñ–π–Ω–∞ –º–æ–¥–µ–ª—å ‚Äî ElasticNet)")
    st.image("data/shap_feature_importance.png", use_container_width=True)

    st.markdown(
        """
    –õ—ñ–Ω—ñ–π–Ω–∞ –º–æ–¥–µ–ª—å **ElasticNet** –ø–æ–∫–∞–∑—É—î –≤–∞–∂–ª–∏–≤—ñ—Å—Ç—å –æ–∑–Ω–∞–∫ —á–µ—Ä–µ–∑ —Å–≤–æ—ó –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏.  
    –ü–æ–∑–∏—Ç–∏–≤–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–±—ñ–ª—å—à—É—é—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂—ñ–≤, –∞ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ñ ‚Äî –∑–º–µ–Ω—à—É—é—Ç—å –π–æ–≥–æ.

    –ù–∞–π–±—ñ–ª—å—à–∏–π –≤–ø–ª–∏–≤ –º–∞—é—Ç—å:
    - –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ñ –æ–∑–Ω–∞–∫–∏  
    - –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü—ñ—è  
    - –ø—Ä–æ–º–æ-–ø–µ—Ä—ñ–æ–¥–∏  

    –¶–µ –¥–æ–ø–æ–≤–Ω—é—î –¥–µ—Ä–µ–≤–Ω—ñ –º–æ–¥–µ–ª—ñ, –∞–ª–µ –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—î –Ω–µ–ª—ñ–Ω—ñ–π–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ.
    """
    )


# =====================================================
# 4. MODEL COMPARISON
# =====================================================
elif page == "–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –º–æ–¥–µ–ª–µ–π":

    st.header("üìà –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —è–∫–æ—Å—Ç—ñ –º–æ–¥–µ–ª–µ–π")

    st.write("–ú–µ—Ç—Ä–∏–∫–∏ –º–æ–¥–µ–ª–µ–π –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –∑ CSV-—Ñ–∞–π–ª—É.")

    metrics = pd.read_csv("data/metrics.csv")
    st.dataframe(metrics, use_container_width=True)

    st.subheader("–ü–æ—è—Å–Ω–µ–Ω–Ω—è –º–µ—Ç—Ä–∏–∫")
    st.write(
        """
        - **RMSE** ‚Äî —Å–µ—Ä–µ–¥–Ω—è –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞ –ø–æ—Ö–∏–±–∫–∞  
        - **MAE** ‚Äî —Å–µ—Ä–µ–¥–Ω—è –∞–±—Å–æ–ª—é—Ç–Ω–∞ –ø–æ—Ö–∏–±–∫–∞  
        - **MAPE** ‚Äî –≤—ñ–¥–Ω–æ—Å–Ω–∞ –ø–æ—Ö–∏–±–∫–∞ —É %  
        - **WAPE** ‚Äî –∑–≤–∞–∂–µ–Ω–∞ –∞–±—Å–æ–ª—é—Ç–Ω–∞ –ø–æ—Ö–∏–±–∫–∞  
        - **R¬≤** ‚Äî –ø–æ—è—Å–Ω–µ–Ω–∞ –¥–∏—Å–ø–µ—Ä—Å—ñ—è  
        """
    )


# =====================================================
# 5. ACTUAL vs PREDICTED
# =====================================================
elif page == "–ü—Ä–æ–≥–Ω–æ–∑–∏ –º–æ–¥–µ–ª–µ–π":

    st.header("üìâ –ü—Ä–æ–≥–Ω–æ–∑–∏ –º–æ–¥–µ–ª–µ–π")

    model = st.selectbox("–û–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å:", ["CatBoost", "RandomForest", "XGBoost"])

    st.image(f"plots/actual_vs_predicted_{model.lower()}.png", use_container_width=True)

    st.write(
        f"–ì—Ä–∞—Ñ—ñ–∫ –ø–æ–∫–∞–∑—É—î, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ –¥–æ–±—Ä–µ –º–æ–¥–µ–ª—å **{model}** –≤—ñ–¥—Ç–≤–æ—Ä—é—î —Ä–µ–∞–ª—å–Ω—ñ –ø—Ä–æ–¥–∞–∂—ñ."
    )


# =====================================================
# 6. RESIDUALS
# =====================================================
elif page == "–ê–Ω–∞–ª—ñ–∑ –∑–∞–ª–∏—à–∫—ñ–≤":

    st.header("üß™ –ê–Ω–∞–ª—ñ–∑ –∑–∞–ª–∏—à–∫—ñ–≤")

    st.write(
        """
        –ó–∞–ª–∏—à–∫–∏ ‚Äî —Ü–µ —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ —Ä–µ–∞–ª—å–Ω–∏–º–∏ —Ç–∞ –ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏.  
        –ê–Ω–∞–ª—ñ–∑ –∑–∞–ª–∏—à–∫—ñ–≤ –¥–æ–ø–æ–º–∞–≥–∞—î –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —è–∫ –º–æ–¥–µ–ª—å –ø–æ–º–∏–ª—è—î—Ç—å—Å—è.
        """
    )

    st.image("plots/residuals_plot.png", use_container_width=True)


# =====================================================
# 7. SHAP EXPLAINABILITY
# =====================================================
elif page == "SHAP ‚Äî –ü–æ—è—Å–Ω–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ":

    st.header("üß† SHAP ‚Äî –ü–æ—è—Å–Ω–µ–Ω–Ω—è –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ –º–æ–¥–µ–ª—ñ")

    st.subheader("1. –ó–∞–≥–∞–ª—å–Ω–∏–π –≤–ø–ª–∏–≤ –æ–∑–Ω–∞–∫ (SHAP Summary ‚Äî CatBoost)")
    st.image("data/shap_values_summary.png", use_container_width=True)

    st.markdown(
        """
    SHAP –ø–æ–∫–∞–∑—É—î, —è–∫ –∫–æ–∂–Ω–∞ –æ–∑–Ω–∞–∫–∞ –≤–ø–ª–∏–≤–∞—î –Ω–∞ –ø—Ä–æ–≥–Ω–æ–∑ –º–æ–¥–µ–ª—ñ **CatBoost**.

    –ù–∞–π–±—ñ–ª—å—à–∏–π –≤–ø–ª–∏–≤ –º–∞—é—Ç—å:
    - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ (CompetitionOpenSinceMonth)
    - –¢–∏–ø –º–∞–≥–∞–∑–∏–Ω—É (StoreType)
    - –°–≤—è—Ç–∫–æ–≤—ñ —Ç–∞ —à–∫—ñ–ª—å–Ω—ñ –¥–Ω—ñ (SchoolHoliday)
    - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∏–∂–Ω—è (–≤–∏—Ö—ñ–¥–Ω—ñ) (IsWeekend)

    SHAP –ø–æ–∫–∞–∑—É—î –Ω–µ–ª—ñ–Ω—ñ–π–Ω—ñ –≤–∑–∞—î–º–æ–∑–≤‚Äô—è–∑–∫–∏, —è–∫—ñ –ª—ñ–Ω—ñ–π–Ω—ñ –º–æ–¥–µ–ª—ñ –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—é—Ç—å.
    """
    )


# =====================================================
# 8. CONCLUSIONS
# =====================================================
elif page == "–í–∏—Å–Ω–æ–≤–∫–∏":

    st.header("‚úî –í–∏—Å–Ω–æ–≤–∫–∏")

    st.write(
        """
        - –ù–∞–π–∫—Ä–∞—â–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å –¥–æ—Å—è–≥–Ω—É—Ç–∞ —Å—Ç–µ–∫—ñ–Ω–≥–æ–º –º–æ–¥–µ–ª–µ–π.  
        - –ú–æ–¥–µ–ª—ñ –¥–æ–±—Ä–µ –≤—ñ–¥—Ç–≤–æ—Ä—é—é—Ç—å —Å–µ–∑–æ–Ω–Ω—ñ—Å—Ç—å —ñ –≤–ø–ª–∏–≤ –ø—Ä–æ–º–æ.  
        - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ —Ç–∞ —Ç–∏–ø –º–∞–≥–∞–∑–∏–Ω—É –º–∞—é—Ç—å —Å—É—Ç—Ç—î–≤–∏–π –≤–ø–ª–∏–≤.  
        - SHAP –ø–æ–∫–∞–∑—É—î –ø—Ä–æ–∑–æ—Ä—É —Ç–∞ —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–æ–≤–∞–Ω—É –ø–æ–≤–µ–¥—ñ–Ω–∫—É –º–æ–¥–µ–ª—ñ.  
        """
    )
